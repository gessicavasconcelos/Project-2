---
title: "Project 2"
author: "Ashley Frankenfield, Gessica Vasconcelos"
date: "4/3/2020"
output: 
  rmdformats::readthedown:
    html_document:
      number_sections: TRUE
      self_contained: TRUE
      lightbox: TRUE
      gallery: FALSE
      highlight: tango 
      thumbnails: true
      toc_float: TRUE
      use_bookdown: TRUE
      code_folding: hide 
      max-width: 1800px
    pdf_document:
      toc: yes
      toc_depth: '3'
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, results = 'hide', message = F, echo=F)
# knitr::opts_chunk$set(include = F)
# knitr::opts_chunk$set(echo = TRUE)
options(scientific=T, digits = 3) 
```

```{r basicfcn}
# use this function to conveniently load libraries and work smoothly with knitting
# can add quietly=T option to the require() function
# note that using this function requires quotes around the package name, as you would when installing packages.
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }
# unload/detact package when done using it 
detach_package = function(pkg, character.only = FALSE) { if(!character.only) { pkg <- deparse(substitute(pkg)) } 
  search_item <- paste("package", pkg,sep = ":") 
  while(search_item %in% search()) { detach(search_item, unload = TRUE, character.only = TRUE) } 
}
```

```{r xkablesummary}
xkabledply = function(modelsmmrytable, title="Table", digits = 4, pos="left", bso="striped") { 
  #' Combining base::summary, xtable, and kableExtra, to easily display model summary. 
  #' wrapper for the base::summary function on model objects
  #' ELo 202004 GWU DATS
  #' version 1.2
  #' @param modelsmmrytable This can be a generic table, a model object such as lm(), or the summary of a model object summary(lm()) 
  #' @param title Title of table. 
  #' @param digits Number of digits to display
  #' @param pos Position of table, c("left","center","right") 
  #' @param bso bootstrap_options = c("basic", "striped", "bordered", "hover", "condensed", "responsive")
  #' @return HTML table for display
  #' @examples
  #' library("xtable")
  #' library("kableExtra")
  #' xkabledply( df, title="Table testing", pos="left", bso="hover" )
  modelsmmrytable %>%
    xtable() %>% 
    kable(caption = title, digits = digits) %>%
    kable_styling(bootstrap_options = bso, full_width = FALSE, position = pos)
}

xkablesummary = function(df, title="Table: Statistics summary.", digits = 4, pos="left", bso="striped") { 
  #' Combining base::summary, xtable, and kableExtra, to easily display numeric variable summary of dataframes. 
  #' ELo 202004 GWU DATS
  #' version 1.2
  #' @param df The dataframe.
  #' @param title Title of table. 
  #' @param digits Number of digits to display
  #' @param pos Position of table, c("left","center","right") 
  #' @param bso bootstrap_options = c("basic", "striped", "bordered", "hover", "condensed", "responsive")
  #' @return The HTML summary table for display, or for knitr to process into other formats 
  #' @examples
  #' xkablesummary( faraway::ozone )
  #' xkablesummary( ISLR::Hitters, title="Five number summary", pos="left", bso="hover"  )
  
  s = summary(df) %>%
    apply( 2, function(x) stringr::str_remove_all(x,c("Min.\\s*:\\s*","1st Qu.\\s*:\\s*","Median\\s*:\\s*","Mean\\s*:\\s*","3rd Qu.\\s*:\\s*","Max.\\s*:\\s*")) ) %>% # replace all leading words
    apply( 2, function(x) stringr::str_trim(x, "right")) # trim trailing spaces left
  
  colnames(s) <- stringr::str_trim(colnames(s))
  
  if ( dim(s)[1] ==6 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max') 
  } else if ( dim(s)[1] ==7 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max','NA') }
  
  xkabledply(s, title=title, digits = digits, pos=pos, bso=bso )
}
```

```{r outlierKD2}
outlierKD2 <- function(df, var, rm=FALSE) { 
    #' Original outlierKD functino by By Klodian Dhana,
    #' https://www.r-bloggers.com/identify-describe-plot-and-remove-the-outliers-from-the-dataset/
    #' Modified to have third argument for removing outliers inwtead of interactive prompt, 
    #' and after removing outlier, original df will not be changed. The function returns the new df, 
    #' which can be saved as original df name if desired.
    #' Check outliers, and option to remove them, save as a new dataframe. 
    #' @param df The dataframe.
    #' @param var The variable in the dataframe to be checked for outliers
    #' @param rm Boolean. Whether to remove outliers or not.
    #' @return The dataframe with outliers replaced by NA if rm==TRUE, or df if nothing changed
    #' @examples
    #' outlierKD2(mydf, height, FALSE)
    #' mydf = outlierKD2(mydf, height, TRUE)
    #' mydfnew = outlierKD2(mydf, height, TRUE)
    dt = df # duplicate the dataframe for potential alteration
    var_name <- eval(substitute(var),eval(dt))
    na1 <- sum(is.na(var_name))
    m1 <- mean(var_name, na.rm = T)
    par(mfrow=c(2, 2), oma=c(0,0,3,0))
    boxplot(var_name, main="With outliers")
    hist(var_name, main="With outliers", xlab=NA, ylab=NA)
    outlier <- boxplot.stats(var_name)$out
    mo <- mean(outlier)
    var_name <- ifelse(var_name %in% outlier, NA, var_name)
    boxplot(var_name, main="Without outliers")
    hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
    title("Outlier Check", outer=TRUE)
    na2 <- sum(is.na(var_name))
    cat("Outliers identified:", na2 - na1, "\n")
    cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "\n")
    cat("Mean of the outliers:", round(mo, 2), "\n")
    m2 <- mean(var_name, na.rm = T)
    cat("Mean without removing outliers:", round(m1, 2), "\n")
    cat("Mean if we remove outliers:", round(m2, 2), "\n")
    
    # response <- readline(prompt="Do you want to remove outliers and to replace with NA? [yes/no]: ")
    # if(response == "y" | response == "yes"){
    if(rm){
        dt[as.character(substitute(var))] <- invisible(var_name)
        #assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
        cat("Outliers successfully removed", "\n")
        return(invisible(dt))
    } else {
        cat("Nothing changed", "\n")
        return(invisible(df))
    }
}
```

```{r loadPkg}
  loadPkg("corrplot")
  loadPkg("dplyr")
  loadPkg("ggplot2")
  loadPkg("tidyverse")
  loadPkg("sqldf")
  loadPkg('tidyr')
```

## Criminal Statistics for DC area
``` {r Load Dataset}
  # read in the CSV file and make it into a data frame
print(getwd())
  require(data.table)
  system.time(df <- fread("Adult_Arrests.csv"))
  df <- data.frame(df)
df <- subset(df, select= -c(2, 7, 8)) #removing CCN and Arrest Number due to them being fictious 
summary(df)

```

```{r Converting to Factors}
df$Race <- as.factor(df$Race)
df$ETHNICITY <- as.factor(df$ETHNICITY)
df$SEX <-as.factor(df$SEX)
df$CATEGORY <- as.factor(df$CATEGORY)
df$DESCRIPTION <-as.factor(df$DESCRIPTION)
# str(df)
```

```{r Counting missing values and removing not relevant variables}
sapply(df, function(x) sum(is.na(x)))
```

```{r Basic Information about Data}
AgeSum <- summary(df$AGE)
YearSum <- summary(df$YEAR)
MonthSum <- summary(df$Month)
Female_Ar <- subset(df, SEX == 3)
Male_Ar <- subset(df, SEX ==2)
Unk_Ar <- subset(df, SEX ==1)
```  

This data set contains information on `r nrow(df)` felony arrests from the District of Columbia between the years 2013-2017. A felony arrest involves the police taking into custody a person that is suspected of having committed a crime. Crimes that are less severe often result in misdemeanor charges, while more serious acts can result in a felony charge. In this data set, both type of charges are included. The crimes recorded here include boating violations, disorderly conduct, arson, homicide and many more. These crimes have resulted in the arrest of `r nrow(Female_Ar)` females, `r nrow(Male_Ar)` were males and `r nrow(Unk_Ar)` of unknown gender orientation. The mean age of those arrested is 34.8 years old. 

```{r Is there any correlation between age and type of crime comitted?}

sex_category <- data.frame(df[c("SEX", "CATEGORY")])
sexcat_Logit <- glm(SEX ~ CATEGORY, data = sex_category, family = "binomial")
summary(sexcat_Logit)
```

By looking at the results from the Logit analysis, we can see that only 5 out of 28 categories are statistically significant. These categories are liquor Law Violations, damage to Property, burglary, offenses against family & children, and arson. As for thee statistically significant variables, category 29 has the lowest p-value suggesting a strong association of the sex of the offender with the probability of comitting arson. The negative coefficient for this predictor suggests that all other variables being equal, the gender is less likely to male passenger is less likely to have survived.



```{r}
hist(df$AGE, # histogram
 col="yellow", # column color
 border="black",
 breaks = 25,
 prob = TRUE, # show densities instead of frequencies
 xlim = c(10,80),
 xlab = "Age",
 main = "Age at which crimes are comitted")
lines(density(df$AGE), # density plot
 lwd = 2, # thickness of line
 col = "blue")
```

The histogram and density lines indicate that the age at which the crimes are committed in DC seems to follow a bimodal distribution. Most of the crimes are committed by people with 18 years old. There is a steep decrease on crimes committed by people with aged between 25 and 42 years old. However, this trend is not sustained and the number crimes increases committed by people with ~ 50 years old increases again. 

```{r Can age be used as a predictor for the type of crime commited}

df1 <- df[c("AGE", "CATEGORY")]

levels(df1$CATEGORY) <- c("Narcotics", "Release Violations/Fugitive", "Robbery", 
"Prostitution", "Traffic Violations", "Theft", "Driving While Intoxicated", "Property Crimes", "Disorderly Conduct", "Simple Assault", "Other Crimes","Liquor Law Violations", "Damage to Property", "Aggravated Assault", "Assault on a Police Officer", "Assault with a Dangerous Weapon", "Burglary", "Offenses Against Family & Children", "Vending Violations", "Sex Abuse", "Kidnapping", "Sex Offenses", "Fraud and Financial Crimes", "Weapon Violations", "Theft from Auto", "Homicide", "Motor Vehicle Theft","Gambling","Arson")


ggplot(df1, aes(x=CATEGORY, y=AGE, fill= CATEGORY)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=1,show.legend = FALSE,
                outlier.size=1) + ggtitle("Type of Crime Comitted according to age") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r Violent crimes comitted at Foggy Botton}
loadPkg("mapproj")
loadPkg("ggmap")
#install.packages("mapproj")
#install.packages("ggmap")
#install.packages("DeducerSpatial")
require(maps)
require(ggmap)
#register_google(key = "AIzaSyA1A_PfatMAo3MAAL_PcctBHkQKxii0Rto")

violent_crimes <- subset(df, CATEGORY != 2)

# rank violent crimes
violent_crimes$CATEGORY <- factor(violent_crimes$CATEGORY, levels = c(16,20,26))
# 3- robbery, 14- aggravated assault, 20- Sex abuse, 26- homicide, 1-Narcotics , 12-Liquor Law Violations, 28-gambling


#dcmap <- qmap('gwu', zoom = 12, color = 'color')

#dcmap +geom_point(aes(x = OFFENSE_LONGITUDE, y = OFFENSE_LATITUDE, size = CATEGORY,colour = CATEGORY), data = violent_crimes )+ theme(legend.box = "vertical",legend.position = "topleft")

```

```{r Is there a relationship between age and the type of crime comitted? }

fit <- lm(AGE ~ CATEGORY, data = df)
summary(fit)
```

```{r Do people commit crime in their neighborhood1}
Liv_OutState <- subset(df, DEFENDANT_PSA == 0) # Arrests of People from out-of-state 
Liv_DC <- subset(df, DEFENDANT_PSA > 100) # Arrests of DC Residents 
Home_Crime <- subset(df, DEFENDANT_PSA == OFFENSE_PSA) #The crime was committed in the area that the defendent lives. 

df2 <- Home_Crime 
levels(df2$CATEGORY) <- c("Narcotics", "Release Violations/Fugitive", "Robbery", 
"Prostitution", "Traffic Violations", "Theft", "Driving While Intoxicated", "Property Crimes", "Disorderly Conduct", "Simple Assault", "Other Crimes","Liquor Law Violations", "Damage to Property", "Aggravated Assault", "Assault on a Police Officer", "Assault with a Dangerous Weapon", "Burglary", "Offenses Against Family & Children", "Vending Violations", "Sex Abuse", "Kidnapping", "Sex Offenses", "Fraud and Financial Crimes", "Weapon Violations", "Theft from Auto", "Homicide", "Motor Vehicle Theft","Gambling","Arson")

Violet_Crime <- filter(Home_Crime, CATEGORY == 2|3)
levels(Violet_Crime$CATEGORY)
```


We wanted to examine whether or not people are more likely to commit a felony offense in their own neighborhood. Based on our findings, `r nrow(Home_Crime)` people, or 24%, of those that committed a crime in DC did so in their own neighborhood. We wanted to extend these findings and see what crimes people are more likely to commit closer to home. For our purposes, we have distinguished between violent offenses, white collar crimes and misdemenors. 

Violent Crimes <- Aggravated Assult, Assult on a Police Officer, Assult with a Dangerous Weapon, Sex Offenses, Kidnapping, Sex Abuse, HOmicide, Weapon Violations, Arson


```{r Feature Selection}
loadPkg("leaps")
Features <- subset(df, select= -c(2, 13, 16:19, 22:25)) #removing coordinates of arrest, description of arrest and coordinates of offense. 
colnames(Features) <- c("ID", "Month", "Day", "Hour", "Age", "Defendant_PSA", "Defendant_District", "Race", "Ethnicity", "Sex", "Category", "Arrest_PSA", "Arrest_District", "Offense_PSA", "Offense_District")


Features <- na.omit(Features)

reg.best10 <- regsubsets(Category~. , data = Features, nvmax = 10, nbest = 2, method = "exhaustive")
plot(reg.best10, scale = "bic", main = "BIC")
summary(reg.best10)

```

```{r Do people commit crime in their neighborhood}
Liv_OutState <- subset(df, DEFENDANT_PSA == 0) # Arrests of People from out-of-state 
Liv_DC <- subset(df, DEFENDANT_PSA > 100) # Arrests of DC Residents 
Home_Crime <- subset(df, DEFENDANT_PSA == OFFENSE_PSA) #DC Resident Commits crime in the area that they live  
Out_Crime_DCres <- subset(Liv_DC, DEFENDANT_PSA!= OFFENSE_PSA) #The crime was committed by a DC resident in an area other than their home. 

Violent_Crime <- Home_Crime %>% filter(CATEGORY == 10 | CATEGORY ==14 | CATEGORY ==15 |CATEGORY == 16 | CATEGORY == 20 | CATEGORY== 22 | CATEGORY == 24 | CATEGORY == 26) %>% droplevels() # Filtering for violent crimes and dropping other levels for DC residents who committed crime in their own neighborhood.

levels(Violent_Crime$CATEGORY) <- c("Simple Assault", "Aggravated Assault", "Assault on a Police Officer", "Assault with a Dangerous Weapon", "Sex Abuse", "Sex Offenses", "Weapon Violations", "Homicide")

Violent_Crime_Plot <- ggplot(Violent_Crime, aes(x=CATEGORY, y=AGE, fill= CATEGORY)) + 
  geom_boxplot(outlier.colour="red", outlier.shape=1,show.legend = FALSE,
                outlier.size=2) + ggtitle("DC Residents who Comitted A Violent Crime Within their Neighborhood")  + theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

Outsider_Crime <- Out_Crime_DCres %>% filter(CATEGORY == 10 | CATEGORY ==14 | CATEGORY ==15 |CATEGORY == 16 | CATEGORY == 20 | CATEGORY== 22 | CATEGORY == 24 | CATEGORY == 26 & DEFENDANT_PSA!=0) %>% droplevels() # Filtering for violent crimes and dropping other levels. 

levels(Outsider_Crime$CATEGORY) <- c("Simple Assault", "Aggravated Assault", "Assault on a Police Officer", "Assault with a Dangerous Weapon", "Sex Abuse", "Sex Offenses", "Weapon Violations", "Homicide")


Outsider_Crime_Plot <- ggplot(Outsider_Crime, aes(x=CATEGORY, y=AGE, fill= CATEGORY)) + 
  geom_boxplot(outlier.colour="red", outlier.shape=1,show.legend = FALSE,
                outlier.size=2) + ggtitle("DC Residents Who comitted a Violent Crime outside their neighborhood")  + theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

OutState <- Liv_OutState %>% filter(CATEGORY == 10 | CATEGORY ==14 | CATEGORY ==15 |CATEGORY == 16 | CATEGORY == 20 | CATEGORY== 22 | CATEGORY == 24 | CATEGORY == 26) %>% droplevels() # Filtering for violent crimes and dropping other levels. 

levels(OutState$CATEGORY) <- c("Simple Assault", "Aggravated Assault", "Assault on a Police Officer", "Assault with a Dangerous Weapon", "Sex Abuse", "Sex Offenses", "Weapon Violations", "Homicide")

OutState_Plot <- ggplot(OutState, aes(x=CATEGORY, y=AGE, fill= CATEGORY)) + 
  geom_boxplot(outlier.colour="red", outlier.shape=1,show.legend = FALSE,
                outlier.size=2) + ggtitle("Out-of-Staters Who comitted a Violent Crime in DC")  + theme(axis.text.x = element_text(angle = 30, hjust = 1)) 

```

We wanted to examine whether or not people are more likely to commit a felony offense in their own neighborhood. Based on our findings, `r nrow(Home_Crime)` people, or 24%, of those that committed a crime in DC did so in their own neighborhood. We wanted to extend these findings and see what crimes people are more likely to commit closer to home. For our purposes, we have distinguished between violent offenses, white collar crimes and misdemenors. 

```{r Counts}
nrow(Home_Crime)
nrow(Liv_OutState)
nrow(Out_Crime_DCres)

#Number of Violent Crimes committed per category 
nrow(Violent_Crime)
nrow(OutState)
nrow(Outsider_Crime)
```

```{r Does age affect Crime Committed}
ageanova <- aov(AGE ~ CATEGORY, data=df)
ageanovasum <- summary(ageanova)
ageanovasum

ggplot(df1, aes(AGE, fill = CATEGORY)) +  geom_histogram(alpha = 0.5, aes(y = ..density..), position = 'identity')
ggplot(df1, aes(AGE, fill = CATEGORY)) + geom_density(alpha = 0.2) 
```
      
```{r does sex affect Crime type, results='show' }
loadPkg("gplots")
gendercontable = xtabs( ~ CATEGORY + SEX, data = df)
chisqsex = chisq.test(gendercontable)
chisqsex
gendercontable
```

## Building a Multinomial Model 

```{r Creating training Set }
loadPkg("class")
set.seed(1)
Features[] <- lapply(Features, as.numeric) # Converting everything to a numeric 
ScaledFeatures <- as.data.frame(scale(Features[1:15], center = TRUE, scale = TRUE))                

Feature_Sample <- sample(2, nrow(ScaledFeatures), replace=TRUE, prob=c(0.67, 0.33))

Training <- ScaledFeatures[Feature_Sample==1, 1:15]
Test <- ScaledFeatures[Feature_Sample==2, 1:15]


Feature_Training <- Features[Feature_Sample==1, 11]
Feature_Test <- Features[Feature_Sample==1, 11]

#prc_test_pred <- knn(train = Training, test = Test,cl = Feature_Training, k=7)
```

```{r Logit, results='show'}
loadPkg("MASS")
logit1 <- lda(Category ~ Hour + Age + Defendant_PSA + Race + Sex + Offense_PSA + Offense_District, data = Training)

Prediction <- logit1 %>% predict(Test)
logit1
exp(coef(logit1))

```




